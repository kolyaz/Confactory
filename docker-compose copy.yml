version: "3.9"

x-common-variables: &common-env # Общие переменные
  SUPABASE_URL: http://supabase-kong:8000
  SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
  SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
  N8N_HOST: ${DOMAIN}
  N8N_PROTOCOL: https
  WEBHOOK_URL: https://${DOMAIN}/webhook
  # Supabase-specific
  JWT_SECRET: ${SUPABASE_JWT_SECRET}
  KONG_HTTP_PORT: 8000
  KONG_HTTPS_PORT: 8443
  PGRST_DB_SCHEMAS: public,graphql,storage
  PGRST_JWT_SECRET: ${SUPABASE_JWT_SECRET}
  ANON_KEY: ${SUPABASE_ANON_KEY}
  SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
  DASHBOARD_USERNAME: ${DASHBOARD_USERNAME}
  DASHBOARD_PASSWORD: ${DASHBOARD_PASSWORD}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  SUPABASE_SECRET_KEY_BASE: ${SUPABASE_SECRET_KEY_BASE}
  DBNAME: postgres
  DB_USER: postgres
  DB_PASSWORD: ${POSTGRES_PASSWORD}
  DB_PORT: 5432
  KONG_CUSTOM_PLUGINS: supabase-jwt
  LOGFLARE_NODE_ID: 1
  LOGFLARE_API_KEY: ${LOGFLARE_API_KEY}
  IMGPROXY_URL: http://supabase-imgproxy:5001
  METADATA_SECRET: ${METADATA_SECRET}
  SHADOW_DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@supabase-shadow:5432/postgres
  SHADOW_DATABASE_URL_READ_REPLICA: postgresql://postgres:${POSTGRES_PASSWORD}@supabase-shadow:5432/postgres
  SUPAVISOR_HOST: supavisor
  SUPAVISOR_DB_URL: postgresql://postgres:${POSTGRES_PASSWORD}@supavisor:6543/postgres
  SUPABASE_DB_URL: postgresql://postgres:${POSTGRES_PASSWORD}@supavisor:${SUPAVISOR_PORT}/postgres?external_id=dev_tenant

services:
  # Studio - Панель инструментов для управления  автономным проектом Supabase
  # Kong - шлюз API Kong маршрутизатор сервисов для  проекта Supabase
  # GoTrue (auth) - API аутентификации на основе JWT для регистрации пользователей, входа в систему и управления сеансами
  # PostgREST (rest) - веб-сервер, который преобразует  базу данных PostgreSQL непосредственно в RESTful API
  # Realtime - сервер Elixir , который прослушивает изменения базы данных PostgreSQL и транслирует их через WEBSOCKET
  # Storage - это сервис для хранения и управления файлами любого типа: изображения, видео, документы, с полной интеграцией с аутентификацией и RLS
  # ImgProxy - высокопроизводительный сервер для обработки изображений, который позволяет изменять размер, обрезать, применять фильтры и оптимизировать изображения без изменения оригиналов
  # postgres-meta - RESTful API для управления Postgres (выборка таблиц, добавление ролей, выполнение запросов)
  # PostgreSQL - Объектно-реляционная база данных с более чем 30-летним опытом активной разработки
  # Edge Runtime - веб-сервер на базе среды выполнения Deno для запуска служб JavaScript, TypeScript и WASM
  # Logflare - платформа для управления журналами и аналитики событий
  # Vector - позволяет Supabase работать с векторными базами данных и семантическим поиском.
  # Supavisor - пул подключений Postgres от Supabase
  # Shadow - для миграций и управления схемой базы данных, "теневой" клон  основной базы данных, который используется исключительно для миграций и управления схемой
  # Meta  - Центраизванная система управления метаданными Supabase, специализированный PostgREST-сервис, который работает с системной базой данных Supabase, а не с  пользовательской БД
  # Redis - Redis для n8n — сервис кэширования и управления очередями для платформы автоматизации n8n.
  # ================== SUPAVISOR (connection pooler) ==================
  supabase-supavisor:
    image: supabase/supavisor:latest # Официальный образ на Elixir (2025: v1.1.5+)
    restart: unless-stopped
    environment:
      <<: *common-env
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/postgres
      POOLER_PORT: ${SUPAVISOR_PORT} #  Порт пулера (обычно 6543)
      DEFAULT_POOLER_MODE: ${SUPAVISOR_MODE} #  Режим работы
      DEFAULT_POOL_SIZE: ${SUPAVISOR_POOL_SIZE:-30}
      DEFAULT_POOL_MODE: transaction #  Режим пула
      POOL_SIZE: ${SUPAVISOR_POOL_SIZE}
      # Multi-tenant: external_id для тенантов
      EXTERNAL_ID_ENABLED: true #  Идентификаторы tenant'ов
      # Логи и метрики
      LOG_LEVEL: info
      PROMETHEUS_ENABLED: true #  Метрики Prometheus
      PROMETHEUS_PORT: 9497
    ports:
      - "${SUPAVISOR_PORT}:6543" # Transaction mode
      - "5432:5432" 
      - "9497:9497" # Metrics
    depends_on:
      supabase-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "6543"]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - supavisor-config:/etc/supavisor # Опционально для кастомного config.exs

  # ================== SUPABASE ( DB-подключения через Supavisor) ==================
  supabase-db:
    image: supabase/postgres:15.1.1.79
    # command: postgres -c config_file=/etc/postgresql/postgresql.conf -c log_statement=all -c log_min_error_statement=warning
    #     #-c config_file=/etc/postgresql/postgresql.conf #  Кастомная конфигурация
    #     #-c log_statement=all #  Логирование ВСЕХ SQL запросов
    #     #-c log_min_error_statement=warning #  Логирование ошибок
    environment:
      PGUSER: supabase_admin #  Основная административная роль
      PGHOST: supabase-db
      PGPASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: postgres
      DATABASE_URL: postgresql://supabase_admin:${POSTGRES_PASSWORD}@supabase-db:5432/postgres
    volumes:
      - supabase-db-data:/var/lib/postgresql/data #  Постоянное хранилище данных
      - ./supabase/postgresql.conf:/etc/postgresql/postgresql.conf #  Конфиг
    healthcheck:
      test: pg_isready -U postgres -h localhost
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  supabase-shadow:
    image: supabase/postgres:15.1.1.79
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    environment:
      PGUSER: supabase_admin # Административный доступ
      PGHOST: supabase-shadow # Имя контейнера = хост
      PGPASSWORD: ${POSTGRES_PASSWORD} # Тот же пароль, что у основной БД
      PGDATABASE: postgres
    volumes:
      - supabase-shadow-data:/var/lib/postgresql/data # Отдельное хранилище
      - ./supabase/postgresql.conf:/etc/postgresql/postgresql.conf # Общая конфигурация
    healthcheck:
      test: pg_isready -U postgres -h localhost
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  supabase-auth:
    image: supabase/gotrue:v2.153.0
    depends_on:
      supabase-db:
        condition: service_healthy
      supabase-meta:
        condition: service_healthy
    environment:
      <<: *common-env
      API_EXTERNAL_URL: https://${DOMAIN}/auth/v1 #  Публичный URL API
      GOTRUE_API_HOST: 0.0.0.0 #  Внутренний хост
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: ${SUPAVISOR_DB_URL}?external_id=auth
      GOTRUE_SITE_URL: https://${DOMAIN} #  URL  сайта
      GOTRUE_JWT_SECRET: ${SUPABASE_JWT_SECRET} #  Секретный ключ для подписи JWT
      GOTRUE_JWT_EXP: 3600 #  Время жизни токена (1 час)
      GOTRUE_DISABLE_SIGNUP: false #  Разрешить регистрацию
      GOTRUE_EXTERNAL_EMAIL_ENABLED: true #  Включить email аутентификацию
      GOTRUE_MAILER_AUTOCONFIRM: false #  Требовать подтверждение email
      GOTRUE_SMTP_HOST: ${SMTP_HOST} #  SMTP сервер
      GOTRUE_SMTP_PORT: ${SMTP_PORT} #  Порт SMTP
      GOTRUE_SMTP_USER: ${SMTP_USER} #  Пользователь SMTP
      GOTRUE_SMTP_PASS: ${SMTP_PASS} #  Пароль SMTP
      GOTRUE_SMTP_ADMIN_EMAIL: ${SMTP_ADMIN_EMAIL} #  Email отправителя
      GOTRUE_MAILER_URLPATHS_CONFIRMATION: /auth/v1/verify
      GOTRUE_MAILER_URLPATHS_INVITE: /auth/v1/verify
      GOTRUE_MAILER_URLPATHS_RECOVERY: /auth/v1/verify
      GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE: /auth/v1/verify
    restart: unless-stopped

  supabase-meta:
    image: supabase/postgrest:v12.0.1
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgresql://pg_meta:${POSTGRES_PASSWORD}@supavisor:${SUPAVISOR_PORT}/postgres?external_id=meta_tenant
      PGRST_DB_SCHEMAS: pg_meta #  Работает ТОЛЬКО с этой схемой
      PGRST_DB_ANON_ROLE: pg_meta_anon #  Специальная роль для доступа
      PGRST_JWT_SECRET: ${SUPABASE_JWT_SECRET}
    restart: unless-stopped

  supabase-kong:
    image: kong:3.4
    environment:
      KONG_DATABASE: "off" #  Бессерверный режим (declarative config)
      KONG_PROXY_ACCESS_LOG: /dev/stdout #  Логи прокси в stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout #  Логи админки в stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr #  Ошибки прокси в stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr #  Ошибки админки в stderr
      KONG_ADMIN_LISTEN: "0.0.0.0:8001, 0.0.0.0:8444 ssl" #  Админ API
      KONG_PLUGINS: bundled,supabase-jwt #  Подключенные плагины
      KONG_LOG_LEVEL: info #  Уровень логирования
    volumes:
      - ./supabase/kong.yml:/etc/kong/kong.yml:ro #  конфигурация
    ports:
      - "8000:8000" #  Прокси (основной API)
      - "8001:8001" #  Админ API
    depends_on:
      supabase-db:
        condition: service_healthy

    restart: unless-stopped

  supabase-rest:
    image: supabase/postgrest:v12.0.1
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      PGRST_DB_URI: ${SUPAVISOR_DB_URL}?external_id=rest
      PGRST_DB_SCHEMAS: public,graphql,storage #  Доступные схемы
      PGRST_DB_ANON_ROLE: anon  #  Роль для неаутентифицированных
      PGRST_JWT_SECRET: ${SUPABASE_JWT_SECRET} #  Секретный ключ для проверки JWT
      PGRST_DB_IF_MATCH_MODE: fingerprint #  Оптимистичная блокировка при обновлении записей,  как PostgREST проверяет, не изменилась ли запись в базе данных с момента её последнего чтения клиентом
    restart: unless-stopped

  supabase-realtime:
    image: supabase/realtime:v2.30.10
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      DB_HOST: supavisor
      DB_PORT: ${SUPAVISOR_PORT}
      DB_USER: supabase_realtime_admin #  Специальная роль для Realtime
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: postgres
      DB_OPTS: sslmode=disable&external_id=realtime_tenant
      JWT_SECRET: ${SUPABASE_JWT_SECRET} #  Проверка аутентификации
      SUPABASE_SECRET_KEY_BASE: ${SUPABASE_SECRET_KEY_BASE} #  Шифрование WebSocket
      HOSTNAME: 0.0.0.0
      PORT: 4000 # WebSocket порт
      DB_MAX_CONNS: 20 # Максимум соединений с БД
    restart: unless-stopped

  supabase-storage:
    image: supabase/storage-api:v0.46.0
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      <<: *common-env
      ANON_KEY: ${SUPABASE_ANON_KEY} #  Для клиентских запросов
      SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY} #  Для административных операций
      JWT_SECRET: ${SUPABASE_JWT_SECRET} #  Проверка аутентификации
      POSTGREST_URL: http://supabase-rest:3000 #  Интеграция с PostgREST
      PGRST_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      DATABASE_URL: ${SUPAVISOR_DB_URL}?external_id=storage
      FILE_STORAGE_BACKEND: file #  Локальное хранилище
      STORAGE_BACKEND: file
      FILE_STORAGE_ROOT_FOLDER: /var/lib/storage #  Папка для файлов
      TENANT_ID: stub
      REGION: stub
      GLOBAL_S3_BUCKET: stub
    volumes:
      - supabase-storage:/var/lib/storage #  Постоянное хранилище
    restart: unless-stopped

  supabase-vec:
    image: supabase/vector:v0.3.0
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      PG_META_DB_HOST: supavisor
      PG_META_DB_NAME: postgres
      PG_META_DB_USER: postgres
      PG_META_DB_PASSWORD: ${POSTGRES_PASSWORD}
      PG_META_DB_PORT: ${SUPAVISOR_PORT}
      PG_META_DB_OPTS: sslmode=disable&external_id=vec_tenant
    restart: unless-stopped

  supabase-logflare:
    image: supabase/logflare:1.5.0
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      LOGFLARE_NODE_ID: 1 #  Идентификатор ноды
      LOGFLARE_API_KEY: ${LOGFLARE_API_KEY} #  Ключ для доступа к API
      DB_USERNAME: postgres #  Подключение к основной БД
      DB_DATABASE: postgres
      DB_HOSTNAME: supavisor
      DB_PORT: ${SUPAVISOR_PORT}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_OPTS: sslmode=disable&external_id=logflare_tenant
      CLICKHOUSE_HOST: supabase-logflare #  Хранилище для логов
      CLICKHOUSE_PORT: 8123
      CLICKHOUSE_SECURE: "false"
    restart: unless-stopped

  supabase-imgproxy:
    image: supabase/imgproxy:v3.8.0
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      IMGPROXY_BIND: :5001 #  Порт сервера
      IMGPROXY_LOCAL_FILESYSTEM_ROOT: /  #  Корневая папка для локальных файлов
      IMGPROXY_USE_S3: "false" #  Отключение S3 (локальная разработка)
      IMGPROXY_USE_GCS: "false" #  Отключение Google Cloud Storage
      IMGPROXY_KEY: ${IMGPROXY_KEY} #  Ключ для подписи URL
      IMGPROXY_SALT: ${IMGPROXY_SALT} #  Соль для безопасности
    restart: unless-stopped

  supabase-studio:
    image: supabase/studio:latest
    depends_on:
      supabase-auth:
        condition: service_started
      supabase-meta:
        condition: service_started
    environment:
      <<: *common-env #  Общие переменные
      SUPABASE_URL: http://supabase-kong:8000 #  Внутренний URL API шлюза
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY} #  Публичный ключ для клиентов
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY} #  Привилегированный ключ
      SUPABASE_PUBLIC_URL: https://${DOMAIN} #  Публичный URL проекта
      STUDIO_PG_META_URL: http://supabase-meta:8080 #  URL сервиса метаданных
      NEXT_PUBLIC_ENABLE_RLS: "true" #  Включение Row Level Security
      LOGFLARE_URL: http://supabase-logflare:4000 #  URL сервиса логов
      LOGFLARE_API_KEY: ${LOGFLARE_API_KEY} #  Ключ для доступа к логам
      SUPABASE_REALTIME_URL: ws://supabase-realtime:4000/socket #  WebSocket для реального времени
      SUPABASE_DB_URL: ${SUPABASE_DB_URL} #  URL базы данных через Supavisor
    restart: unless-stopped

  # ================== EDGE RUNTIME  ==================
  supabase-edge-runtime:
    image: supabase/edge-runtime:latest # Официальный Deno-based образ (2025: v1.48.0+)
    restart: unless-stopped
    environment:
      <<: *common-env
      SUPABASE_URL: ${SUPABASE_URL} #  URL  проекта
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY} #  Публичный ключ
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY} #  Сервисный ключ
      JWT_SECRET: ${SUPABASE_JWT_SECRET}
      DATABASE_URL: ${SUPAVISOR_DB_URL}?external_id=edge
      DENO_DEPLOYMENT_ID: local #  Идентификатор деплоя
      DENO_REGION: us-east-1 # Регион выполнения
    volumes:
      - ./functions:/usr/local/lib/edge-runtime/services # Директория с функциями 
    command:
      [
        "start",
        "--main-service",
        "/usr/local/lib/edge-runtime/services", #  Путь к функциям
        "-p",
        "9001", #  Порт выполнения
      ]
    ports:
      - "9001:9001" # Внутренний порт для функций
    depends_on:
      supavisor:
        condition: service_healthy
      supabase-auth:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9001/_health"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - traefik.enable=true
      - traefik.http.routers.edge-runtime.rule=Host(`${DOMAIN}`) && PathPrefix(`/functions`)
      - traefik.http.routers.edge-runtime.tls.certresolver=letsencrypt
      - traefik.http.routers.edge-runtime.entrypoints=websecure
      - traefik.http.services.edge-runtime.loadbalancer.server.port=9001

  # ================== n8n (обновлено: DB через Supavisor) ==================
  n8n-redis:
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"] #  Проверка здоровья через redis-cli ping
    volumes:
      - n8n-redis-data:/data #  Постоянное хранилище для данных

  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    environment:
      <<: *common-env #  Общие переменные
      DB_TYPE: postgresdb #  Использование PostgreSQL
      DB_POSTGRESDB_HOST: supavisor #  Хост БД через пулер
      DB_POSTGRESDB_PORT: ${SUPAVISOR_PORT}
      DB_POSTGRESDB_DATABASE: postgres
      DB_POSTGRESDB_USER: postgres
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_OPTS: sslmode=disable&external_id=n8n_tenant
      N8N_BASIC_AUTH_ACTIVE: true #  Включение базовой аутентификации
      N8N_BASIC_AUTH_USER: ${N8N_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY} #  Ключ шифрования
      EXECUTIONS_MODE: queue #  Выполнение через Redis очереди
      QUEUE_BULL_REDIS_HOST: n8n-redis
      QUEUE_BULL_REDIS_PORT: 6379
    volumes:
      - n8n-data:/home/node/.n8n #  Постоянное хранилище данных n8n
    depends_on:
      supavisor:
        condition: service_healthy
      n8n-redis:
        condition: service_healthy
    labels:
      - traefik.enable=true
      - traefik.http.routers.n8n.rule=Host(`${DOMAIN}`) && PathPrefix(`/n8n`)
      - traefik.http.routers.n8n.tls.certresolver=letsencrypt
      - traefik.http.routers.n8n.entrypoints=websecure
      - traefik.http.services.n8n.loadbalancer.server.port=5678

  # ================== Quasar Frontend (обновлено: env для Supavisor) ==================
  quasar:
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    restart: unless-stopped
    environment:
      <<: *common-env
      VITE_SUPABASE_URL: ${SUPABASE_URL}
      VITE_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      VITE_SUPABASE_DB_URL: ${SUPABASE_DB_URL} # Для клиентских подключений
    volumes:
      - ./frontend/quasar-app:/app
    labels:
      - traefik.enable=true
      - traefik.http.routers.quasar.rule=Host(`${DOMAIN}`)
      - traefik.http.routers.quasar.tls.certresolver=letsencrypt
      - traefik.http.routers.quasar.entrypoints=websecure
      - traefik.http.services.quasar.loadbalancer.server.port=9000

  # ================== Traefik (обновлён: добавлен роут для Edge) ==================
  traefik:
    image: traefik:v3.0
    restart: unless-stopped
    command:
      - --providers.docker=true #  Авто-обнаружение сервисов Docker
      - --providers.docker.exposedbydefault=false #  Только явно размеченные сервисы
      - --entrypoints.web.address=:80 #  HTTP порт 80
      - --entrypoints.websecure.address=:443 #  HTTPS порт 443
       # Let's Encrypt SSL сертификаты
      - --certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      # HTTP → HTTPS редирект
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
    ports:
      - "80:80" #  Публичный HTTP порт
      - "443:443" #  Публичный HTTPS порт
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro #  Доступ к Docker API
      - traefik-certs:/letsencrypt #  Хранилище SSL сертификатов
    labels:
      - traefik.enable=true
      # Supabase Studio
      - traefik.http.routers.supabase-studio.rule=Host(`${DOMAIN}`) && PathPrefix(`/studio`)
      - traefik.http.routers.supabase-studio.tls.certresolver=letsencrypt
      - traefik.http.services.supabase-studio.loadbalancer.server.port=3000
      # Supabase API (Kong)
      - traefik.http.routers.supabase-api.rule=Host(`${DOMAIN}`) && PathPrefix(`/rest/v1`, `/graphql/v1`, `/storage/v1`, `/auth/v1`)
      - traefik.http.routers.supabase-api.tls.certresolver=letsencrypt
      - traefik.http.services.supabase-api.loadbalancer.server.port=8000

# ================== Volumes ==================
volumes:
  supabase-db-data:
  supabase-shadow-data:
  supabase-storage:
  n8n-data:
  n8n-redis-data:
  traefik-certs:
  supavisor-config:
